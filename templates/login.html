<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>M5大数据-平台登陆</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="./static/css/login.css">
</head>
<body>
<div id="root" v-cloak>
    <nav-bar></nav-bar>
    <div class="wrapper_lr" v-cloak>
        <img style="height: 500px;margin: 30px;margin-left:10%;" src="/static/images/banner.png"/>
        <div class="lr_wrapper_panel">
            <el-card class="input_container" shadow="always" style="width:360px">
                <el-divider>用户登录</el-divider>
                <br>
                <el-form :rules="rules" ref="form" label-position="right" label-width="60px" :model="form" class="form-x">
                    <el-form-item label="手机号" prop="mobile">
                        <el-input maxlength="11" clearable v-model="form.mobile" placeholder="请输入手机号"></el-input>
                        <i class="el-icon-circle-check check_user" v-show="checkSuccess"></i>
                    </el-form-item>
                    <el-form-item label="密码" prop="password">
                        <el-input maxlength="20" clearable type="password" show-password v-model="form.password" autocomplete="off" placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-form-item label="" style="margin-bottom: 0">
                        <el-button type="submit" style="width: 100%" class="btn el-button--primary" @click="submit('form')">登录</el-button>
                    </el-form-item>
                    <el-form-item label="" style="margin-bottom: 0;">
                        <div style="display: flex;">
                            <el-button type="text" @click="toRegisterPage" style="text-align: center;font-weight: 100">注册新账号</el-button>
                            <div style="flex:1"></div>
                            <el-button type="text" @click="toRegisterPage" style="text-align: center;font-weight: 100">忘记密码？</el-button>
                        </div>
                       </el-form-item>
                </el-form>
            </el-card>
        </div>
    </div>
    <foot></foot>
</div>
<script src="https://unpkg.com/vue@next"></script>
<script src="https://unpkg.com/element-plus/lib/index.full.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<script src="static/js/common.js"></script>
<script src="static/js/components/nav.js"></script>
<script src="static/js/components/foot.js"></script>

<script>
const csrftoken = Cookies.get('csrftoken');
const app = Vue.createApp({
    delimiters: ["[[","]]"],
    data() {
        const validateMobile = (rule, value, callback) => {
            if (/^1[3-9]\d{9}$/.test(value)) {
                callback()
            } else {
                callback(new Error('手机号格式不正确'));
            }
        }
        const validatePassword = (rule, value, callback) => {
            if(/^[a-zA-Z0-9]{6,18}$/.test(value)) {
                if (this.form.password !== '') {
                    this.$refs.form.validateField('repeatPassword');
                }
                callback();
            } else {
                callback(new Error('密码为6-18位字母或数组组成'));
            }
        };
        return {
            form: {
                mobile: '',
                password: '',
            },
            rules: {
                mobile: [
                    {validator: validateMobile, trigger: 'blur'}
                ],
                password: [
                    {validator: validatePassword, trigger: 'blur'}
                ],
            }
        }
    },
    methods: {
        submit(formName) {
            this.$refs[formName].validate((valid) => {
                if (valid) {
                    const formData = new FormData();
                    formData.append('username', this.form.mobile)
                    formData.append('password', this.form.password)
                    axios.post('/login', formData, { headers: {"Content-Type": "application/x-www-form-urlencoded",'X-CSRFToken': csrftoken}}).then(
                        res => {
                            console.log(res)
                            if(res.data.success) {
                                location.href = '/'
                            } else {
                                this.$notify({
                                    title: '提示',
                                    message: '用户名或者密码错误',
                                    type: 'error'
                                })
                            }
                        }
                    )
                } else {
                    return false;
                }
            })
        },
        toRegisterPage () {
            location.href='/signup'
        },
        toHomePage () {
            location.href='/'
        },
    }
})
app.use(ElementPlus);
app.component('nav-bar', nav)
app.component('foot', foot)
app.mount('#root')
</script>
</body>
</html>